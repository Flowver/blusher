<!DOCTYPE html>
<html lang="ko">
<head>
	<title id="titleCheck">BLUSHER_MYPAGE</title>
	<meta charset="UTF-8">
    <link rel="apple-touch-icon" sizes="57x57" href="images/faviconapple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="images/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="images/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="images/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="images/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon//favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png">
    <link rel="manifest" href="images/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="images/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

	<link rel="stylesheet" href="css/web.css" />
	<link rel="stylesheet" href="css/layout_font.css" />
	<link rel="stylesheet" type="text/css" href="slick/slick.css"/>
	<link rel="stylesheet" type="text/css" href="slick/slick-theme.css"/>
    
    <!--Javascript Libraries-->
    <script src="js/jquery-3.5.1.min.js"></script>
    <style>
        #wrapper {width: 1600px; margin: 0 auto;}
        header {width: 1600px; height: 70px; background: rgba(0,0,0,0);}
        section {clear: both; float: center; position: relative;  width: 1600px; height: 1200px; background: rgba(0,0,0,0);}
        footer {clear: both; width: 1600px; height: 50px; background: rgba(0,0,0,0);}

    /* 미디어 쿼리 */
    /* 화면 너비 0 ~ 1200px */
        @media (max-width: 1600px){
        #wrapper {width: 95%;}
        header {width: 100%;}
        section {width: 100%;}
        footer {width: 100%;}
        }

    /* 화면 너비 0 ~ 768px */
        @media (max-width: 768px){
        #wrapper {width: 100%;}
        section {width: 100%; height: 300px;}
        }

    /* 화면 너비 0 ~ 480px */
        @media (max-width: 480px){
        #wrapper {width: 100%;}
        header {height: 100%;}
        }

        .edit{
		width:auto;
		margin:auto;
		margin-top: 35px;
		padding: 7.5px 15px;
		font-family:"NotoSansCJKkr-Medium";
		font-size: 19px;
		letter-spacing: -1.5px;	
		text-align:center;
		background: teal;
		border: 1px #006d6d solid;
		color: #fff;
		transition: 0.3s ease;
		}

		.edit:hover{
		background: #006d6d;
		border-color: #005959;
		color: #fff;
        }
        
        .save{
		width:auto;
		margin:auto;
		margin-top: 35px;
		padding: 7.5px 15px;
		font-family:"NotoSansCJKkr-Medium";
		font-size: 19px;
		letter-spacing: -1.5px;	
		text-align:center;
		background: #00ad8d;
		border: 1px #006d6d solid;
		color: #fff;
		transition: 0.3s ease;
		}

		.save:hover{
		background: #006d6d;
		border-color: #005959;
		color: #fff;
		}

        .pic{
        margin:auto;
        }

        .nic{
        margin:auto;
        }


    </style>
</head>
<body>
<!--Header -->
	<script>
		$(function() {
			$(".toggle").on("click", function() {
				if ($(".item").hasClass("active")) {
					$(".item").removeClass("active");
					$(this).find("a").html("<i class='fa fa-bars'></i>");
				} else {
					$(".item").addClass("active");
					$(this).find("a").html("<i class='fa fa-times'></i>");
				}
			});
		});
	</script>
	<div id="wrapper">
		<header>
			<!-- <a href="index.html"><div type="img" class="logo fadein"></div></a> -->
			<!--Top Navigation -->		
				<nav id="topnav">
					<ul class="menu fadein">
                        <a href="index.html"><div class="logo"></div></a>
						<a href="blusher.html"><li class="item">BLUSHER</li></a>
                        <a href="news.html"><li class="item">NEWS</li></a>
                        <a href="album.html"><li class="item">ALBUM</li></a>
                        <a href="gallery.html"><li class="item">GALLERY</li></a>
						<a href="guestbook.html"><li class="item">GUESTBOOK</li></a>
						
						<div class="item button"><a id="loginmenu" href="login.html">LOGIN</a></div>
						<div class="item button secondary"><a id="joinmenu" href="join.html">SING UP</a></div>
						<div class="toggle"><a href="#"><i class="fa fa-bars"></i></a></div>
					</ul>
				</nav>
		</header>
		
		<!-- Section -->
		<section style="background-color:white;">
		 <!-- userkey 비교하기. 현재로그인 한사람의 userkey면 마이 페이지 리스트 출력, 다른사람userkey 면 다른사람이름+ page 출력 -->
            <p class="boxh1 fadein">마이페이지</p>
            <!-- 프로필 사진 부분 -->
                <div align="center" class="pic">
                    <img id="myimage" src="https://www.w3schools.com/bootstrap/img_avatar3.png" class="media-object" style="width:60px">
            <!-- file -->        
                    <div id="showfile">
                    </div>

                </div>
                <div align="center" class="nic">
                    <p type="text" class="media-heading" id="nicname">닉네임</p></br>
                    <div id="statetxtP">
                        <p id="statetxt">.</p>
                    </div>
                </div>
                <br>
    
                <div align="right">
                    <button id="changeBtn" type="button" class="edit">수정하기</button>
                </div>
            <hr>
            <br>
    
            <!-- 감사리스트 출력하기-->
                <p class="boxh2">나의 감사리스트</p>
                <br>
                <!-- 감사 리스트 붙일 곳 -->
                <div class="thanksList"></div>
		</section>
		
		<!-- Footer -->
		<footer>
			<div id="footer">
				<p>&copy Copyright 2020. blue. All rights reserved. Contact: <a href="sis04263@gmail.com">Mail</a></p>
			</div>
		</footer>
    </div>
    
<!-- Script -->
    <!--현재 시간을 가져오는 js 파일 -->
    <script src="./js/time.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase.js"></script>
    <script src="./js/sessionCheck_mypage.js"></script>
    <script>
    var firebaseEmailAuth; //파이어베이스 email 인증 모듈 전역변수
    var firebaseDatabase; //파이어베이스 db 모듈 전역변수
    //var currentTime; // 현재 시간 가져오는 함수, time.js 파일에 따로 빼놓았다.
    var name; //유저 이름
    var loginUserKey; //로그인한 유저의 부모 key
    var userInfo; //로그인한 유저의 정보 object type
    var comment; //유저가 쓴글 내용 저장

    //파이어 베이스 초기화 코드
	var config = {
        apiKey: "AIzaSyAVOIF29TmYY79IOdS7aFkuHUtmdHH8ydA",
        authDomain: "blusherx.firebaseapp.com",
        databaseURL: "https://blusherx.firebaseio.com",
        projectId: "blusherx",
        storageBucket: "blusherx.appspot.com",
        messagingSenderId: "602295468180",
        appId: "1:602295468180:web:865441fa8a8442739a7481",
        measurementId: "G-BKQCDXF778"
    };
    //파이어베이스 초기화
    firebase.initializeApp(config);
    //인증모듈 객체 가져오기
    firebaseEmailAuth = firebase.auth();
    //데이터베이스 모듈객체 가져오기
    firebaseDatabase = firebase.database();

    </script>

    <script>
    
    //땡스리스트 thanks 테이블의 thanks 키 들을 연속적으로 가져온다.
    function on_thanks_list(data) {
        console.log("on_thanks_list() 함수안으로 들어왔습니다 리스트를 가져오겠습니다")
        //글 게수만큼 반복된다.
        //alert(loginUserKey);
        //alert(data.val().userkey);
        //헌재 로그인한 유저의 key와 감사리스트 객체의 user key가 일치하는 것 만 가져오기
        if (loginUserKey == data.val().userkey) {
            var key = data.key;
            var Data = data.val();
            var thankComment = Data.comment;
            var createtime = Data.createtime;
            var name = Data.name;
            var userkey = Data.userkey;

            var mod_btn_key = key + "mod_btn"

            //감사리스트 동적으로 붙이기
            var html =
                "<h4 class=\"media-heading\">" + name +
                " <span STYLE=\"color: green; font-size: 5pt\">" + createtime + "</span></h4>" +
                "<div id='" + key + "'><p>" + thankComment + "</p>" +
                "<div align=\"right\" id='" + mod_btn_key + "'>" +
                "<button type=\"button\" class=\"edit\" id='" + mod_btn_key + "' onclick=\"btn_modify('" + key + "')\">수정</button>" +
                " " +
                "<button type=\"button\" class=\"save\" onclick=\"btn_delete('" + key + "')\">삭제</button>" +
                "</div></div>" +
                "<hr>";


            $(".thanksList").append(html);
        }
    }


    function myThanksList() {
                console.log("땡스 리스트 함수안으로 들어왔습니다")
    
                var thanksRef = firebaseDatabase.ref('thanks');
                //조회
                thanksRef.on('child_added', on_thanks_list)
            }    

    $(document).ready(function () {
        //세션체크 함수먼저 호출!
        userSessionCheck();
        setTimeout(function() {
            //내가쓴 글만 가져오는 함수
            myThanksList();
        }, 1000);


    });

    //수정 버튼이 click 되기를 대기하고 있는 이벤트 함수
    $(document).on('click', '#changeBtn', function () {
            changeButtonAction();
    });

    //수정, 저장하기 버튼 눌렀을 때 작동하는 함수
    function changeButtonAction(){
        console.log("버튼이 눌렀습니다");
        var changeBtn = document.getElementById("changeBtn");
        var changeBtnText = changeBtn.textContent; //버튼의 text제목을 가져온다.
        
        //버튼이 수정하기 버튼이면
        if (changeBtnText == "수정하기") {
            console.log("수정하기 버튼 - input file 나타나고 - p 태그 대신 input text 태그로 변경시키기 - 저장버튼 활성화 작업을 시작합니다");

            //input file 붙여주기 - id가 fileButton 인 filetpye의 엘리먼트를 붙여주었다.
            var html = "<input type=\"file\" id=\"fileButton\" />";
            $("#showfile").append(html);
            console.log("input file 붙여주기 완료");

            //기존에 한줄 메시지 없애주고, 새로운 input text 붙여주기
            var parent = document.getElementById("statetxtP");
            var child = document.getElementById("statetxt");
            parent.removeChild(child);
            console.log("한줄 메시지가 들어있는 p 태그 삭제 완료");

            //한줄 메시지 적을 textarea 창 활성화
            var newTextarea = "<textarea class=\"form-control\" rows=\"3\" id=\"comment\"></textarea>";
            $("#statetxtP").append(newTextarea);
            console.log("한줄 메시지 적을 textarea 창 활성화 완료");

            //저장하기 버튼 활성화
            changeBtn.textContent = "저장하기"
            changeBtn.className = "save"; //클래스 속성 변경해주기
        } else {
        console.log("저장 버튼 - input file 사라지게 input text태그 사라지고 p 태그에 넣고 저장버튼 비활성화 수정버튼 활성화를 시작합니다");
        //저장하기 함수 호출
        console.log("저장하기 함수 호출");
        var saveChack = imageStateMsgAllSave();

        if (saveChack) {
            //활성화된 input file 객체 삭제                    
            var parent = document.getElementById("showfile");
            var child = document.getElementById("fileButton");
            parent.removeChild(child);
            console.log("활성화된 input file 객체 삭제 완료");

            //input text area 객체 삭제해주기
            var parentTwo = document.getElementById("statetxtP");
            var childTwo = document.getElementById("comment");
            parentTwo.removeChild(childTwo);
            console.log("활성화된 input text area 객체 삭제 완료");


            //p태그에 수정한 한줄 메시지 넣어주기
            var htmlThree = "<p id=\"statetxt\">" + comment + "</p>";
            $("#statetxtP").append(htmlThree);
            console.log("할줄메시지가 들어있는 p 태그 활성화");

            changeBtn.textContent = "수정하기"
            changeBtn.className = "edit";

            console.log("저장되었습니다");
            }
        }
    }

    //이미지와 한줄글 최종 저장하는 함수!
    function imageStateMsgAllSave() {
        console.log("imageStateMsgAllSave로 들어왔습니다");

        //파일을 파이어 베이스 스토리지에 저장하는 로직
        var fileButton = document.getElementById("fileButton");
        comment = document.getElementById("comment").value;
        alert(comment);
        //수정 버튼을 눌러서 fileButton 객체가 생기면~! 작동
        if (fileButton) {
            //fileButton.addEventListener('change', function (e) {
            console.log("fileButton.addEventListener('change', function(e){ 함수 호출 - 들어왔습니다");
            var file = fileButton.files[0];
            //현재 유저 키를 파일이름으로 지정
            var storageRef = firebase.storage().ref(loginUserKey);
            var task = storageRef.put(file);
            // #.핵심
            //이곳에서 파이어베이스 스토리지에도 저장해주고, 데이터베이스에도 저장해줘야 함.
            //유저키(부모키)를 레퍼런스로 잡고 url 추가해줌 userSessionCheck() 먼저 실행
            //사진을 업데이트 하고 현재 상태글 업데이트 하고, 다시 불러오기
            //비동기 방식으로 움직임
            //최종완료되었을때 이곳에서 끝난다
            task.then(function (snapshot) {
                url = snapshot.getDownloadURL();
                console.log("파이어베이스 스토리지에 저장된 주소 =  " + url);
                //파이어베이스에 이미지를 저장한후 그 url을 바로 가져와서 img 태그에 적용해줌
                document.querySelector('#myimage').src = url;
                //여기에 user 레퍼런스에 사진 url 저장
                //선택된 키가 있으면 수정
                userRef = firebaseDatabase.ref('users/' + loginUserKey);
                userRef.update({
                    createtime: currentTime,
                    name: name,
                    imgURl: url,
                    comment: comment
                });
                console.log("파이어베이스 데이터베이스 user 레퍼런스에 성공적으로 저장 완료");
                alert("성공적으로 변경되었습니다.")

            })
                .catch(function (error) {
                    console.error(error);
                    return;
                });

            //});

        }
        return true;
    }

    </script>

</body>
</html>








